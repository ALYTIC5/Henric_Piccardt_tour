<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>Henric Piccardt Tour</title>
  <meta name="theme-color" content="#1d1d1b" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #000;
    }

    /* Background layer (fixed) */
    #bg {
      position: fixed;
      inset: 0;
      background: center center / cover no-repeat;
    }

    /* Nameplate (optional) */
    #nameplate {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 55%;
      height: auto;
      z-index: 15;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1.2s ease-in;
    }
    #nameplate.visible { opacity: 1; }

    .hidden { display: none !important; }

    /* Permission gate (original) */
    .gate {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 18%;
      z-index: 20;
      background: rgba(0,0,0,0.05);
    }
    .card {
      width: min(90vw, 420px);
      border-radius: 18px;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      padding: 18px;
      text-align: center;
    }
    .card h1 { font-size: 1.1rem; margin: 6px 0 10px; }
    .card p { font-size: .95rem; margin: 0 10px 12px; }
    .row { display: flex; gap: 10px; }
    .btn {
      flex: 1 1 auto;
      padding: 12px 14px;
      border-radius: 12px;
      border: 2px solid transparent;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-allow { background: #0b6efd; color: #fff; }
    .btn-deny { background: #eee; color: #111; }

    .small { font-size: 0.86rem; color: #333; margin-top: 8px; }
    .link { color: #0b6efd; text-decoration: underline; cursor: pointer; font-weight: 600; }

    .widget-container {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 480px;
      z-index: 10;
    }
    .widget-container > elevenlabs-convai,
    .widget-container iframe {
      width: 100%;
      height: 140px;
    }

    /* Privacy dialog (unchanged) */
    dialog.privacy {
      width: min(92vw, 560px);
      border: none;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      padding: 0;
      max-height: 80vh;
    }
    dialog::backdrop { background: rgba(0,0,0,0.45); }
    .dialog-body { padding: 18px 18px 6px; }
    .dialog-header {
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px; border-bottom: 1px solid #eee;
    }
    .dialog-title { margin:0; font-size: 1rem; font-weight: 800; }
    .dialog-close {
      border:none; background:#eee; color:#111; font-weight:700;
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .dialog-content {
      padding: 0 16px 16px;
      font-size: .95rem; line-height: 1.45; white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- Start with the original permission background -->
  <div id="bg" style="background-image:url('Background 1.png')"></div>
  <img id="nameplate" src="name-removebg.png" alt="Henric Piccardt" />

  <div class="gate" id="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card">
      <h1 id="gateTitle">Microfoon inschakelen?</h1>
      <p>Deze tour gebruikt de ElevenLabs stem-assistent en heeft toegang tot je microfoon nodig.</p>
      <div class="row">
        <button class="btn btn-deny" id="denyBtn">Niet nu</button>
        <button class="btn btn-allow" id="allowBtn">Toestaan</button>
      </div>
      <p class="small">
        üåê Uitgebreider privacy statement
        (<span id="openPrivacy" class="link" role="button" tabindex="0" aria-controls="privacyDialog">lees meer</span>)
      </p>
    </div>
  </div>

  <dialog id="privacyDialog" class="privacy" aria-labelledby="privacyTitle">
    <div class="dialog-header">
      <h2 class="dialog-title" id="privacyTitle">üåê Uitgebreider privacy statement</h2>
      <button class="dialog-close" id="closePrivacy" aria-label="Sluiten">Sluiten</button>
    </div>
    <div class="dialog-body">
      <div class="dialog-content">
Privacyverklaring interactieve audiotour

Deze applicatie wordt aangeboden door Fine Tune Audio. Wanneer u met Henric Piccardt in gesprek gaat, verwerken wij uw ingevoerde tekst of gesproken woorden om direct een antwoord te genereren. Hiervoor maken wij gebruik van:

OpenAI (taalverwerking)

ElevenLabs (tekst-naar-spraak)

Uw gegevens worden uitsluitend gebruikt om de gesprekken in realtime mogelijk te maken. Ze worden niet opgeslagen door Fine Tune Audio, OpenAI of ElevenLabs.

Rechtsgrond: dit gebeurt op basis van uw toestemming.
Uw rechten: u kunt uw toestemming altijd intrekken en vragen stellen over de verwerking.
Contact: support@finetune.audio
      </div>
    </div>
  </dialog>

  <div class="widget-container hidden" id="widgetContainer"></div>
  <audio id="bgMusic" src="BG_Lowest.mp3" loop preload="auto" playsinline webkit-playsinline></audio>

  <script>
    /* ====== CONFIG ====== */
    const AGENT_ID = "agent_4401k3npmamcf5hawj56bagnz96v"; // Hendric agent
    const CONVO_BG = "background_convo.png";

    /* ====== DOM ====== */
    const bg = document.getElementById("bg");
    const gate = document.getElementById("gate");
    const allowBtn = document.getElementById("allowBtn");
    const denyBtn = document.getElementById("denyBtn");
    const widgetContainer = document.getElementById("widgetContainer");
    const bgMusic = document.getElementById("bgMusic");
    const nameplate = document.getElementById("nameplate");

    // Privacy dialog
    const privacyDialog = document.getElementById("privacyDialog");
    document.getElementById("openPrivacy").addEventListener("click", () => privacyDialog.showModal());
    document.getElementById("closePrivacy").addEventListener("click", () => privacyDialog.close());

    // Preload convo background for instant swap
    (new Image()).src = CONVO_BG;

    /* ====== AUDIO GRAPH ‚Äî ALWAYS-START STRATEGY ====== */
    let audioCtx, bgSource, bgGain;

    function setupAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        bgSource = audioCtx.createMediaElementSource(bgMusic);
        bgGain   = audioCtx.createGain();
        bgGain.gain.value = 0.20; // constant 20%

        bgSource.connect(bgGain).connect(audioCtx.destination);

        // Ensure only Web Audio path is audible
        bgMusic.muted  = true;
        bgMusic.volume = 1.0;

        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible" && audioCtx.state === "suspended") {
            audioCtx.resume().catch(()=>{});
          }
        });
        window.addEventListener("pageshow", () => {
          if (audioCtx.state === "suspended") {
            audioCtx.resume().catch(()=>{});
          }
          nudgePlay();
        });
        window.addEventListener("focus", nudgePlay);
      }

      if (audioCtx.state === "suspended") {
        audioCtx.resume().catch(()=>{});
      }
    }

    function nudgePlay() {
      [0, 120, 240, 480, 960, 1440].forEach(ms => {
        setTimeout(() => { if (bgMusic.paused) bgMusic.play().catch(()=>{}); }, ms);
      });
      [2000, 3000, 4500, 6000, 8000].forEach(ms => {
        setTimeout(() => { if (bgMusic.paused) bgMusic.play().catch(()=>{}); }, ms);
      });
      const start = performance.now();
      function rafKick(t) {
        if (!bgMusic.paused) return;
        bgMusic.play().catch(()=>{});
        if (t - start < 2000) requestAnimationFrame(rafKick);
      }
      requestAnimationFrame(rafKick);
    }

    function startBed() {
      try { bgMusic.currentTime = 0; } catch(e) {}
      bgMusic.play().catch(()=>{});
      nudgePlay();
      bgMusic.addEventListener("pause", () => {
        if (document.visibilityState !== "visible") return;
        bgMusic.play().catch(()=>{});
        nudgePlay();
      });
    }

    /* ====== ELEVENLABS WIDGET (AI @100%) ======
       Robust loader: try unpkg first, then ElevenLabs CDN.
    ================================================= */
    const WIDGET_PRIMARY = 'https://unpkg.com/@elevenlabs/convai-widget-embed';
    const WIDGET_FALLBACK = 'https://elevenlabs.io/convai-widget/index.js';

    function ensureScript(src, attrs = {}) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing && existing.dataset._loaded === "1") {
          resolve();
          return;
        }
        const s = existing || document.createElement('script');
        s.src = src;
        s.async = true;
        Object.entries(attrs).forEach(([k,v]) => s.setAttribute(k, v));
        s.onload = () => { s.dataset._loaded = "1"; resolve(); };
        s.onerror = reject;
        if (!existing) document.head.appendChild(s);
      });
    }

    function waitForElementDefined(name, timeoutMs = 3000) {
      if (customElements.get(name)) return Promise.resolve();
      return new Promise((resolve, reject) => {
        let done = false;
        const to = setTimeout(() => {
          if (!done) { done = true; reject(new Error('timeout')); }
        }, timeoutMs);
        customElements.whenDefined(name).then(() => {
          if (!done) { done = true; clearTimeout(to); resolve(); }
        }).catch(err => {
          if (!done) { done = true; clearTimeout(to); reject(err); }
        });
      });
    }

    async function injectWidget() {
      // Try primary
      let defined = false;
      try {
        await ensureScript(WIDGET_PRIMARY);
        await waitForElementDefined('elevenlabs-convai', 2500);
        defined = true;
      } catch(_) {}

      // Fallback if not defined
      if (!defined) {
        try {
          await ensureScript(WIDGET_FALLBACK, { 'data-elevenlabs-convai': 'true' });
          await waitForElementDefined('elevenlabs-convai', 4000);
          defined = true;
        } catch (e) {
          console.warn('ElevenLabs widget failed to load from both sources.', e);
        }
      }

      // Insert widget either way; if defined it will upgrade immediately when ready
      widgetContainer.innerHTML =
        `<elevenlabs-convai agent-id="${AGENT_ID}" style="--voice-volume:1;"></elevenlabs-convai>`;
      widgetContainer.classList.remove("hidden");

      // Extra background reassert + audio nudges
      setTimeout(() => bg.style.backgroundImage = `url('${CONVO_BG}')`, 150);
      setTimeout(() => bg.style.backgroundImage = `url('${CONVO_BG}')`, 600);
      setTimeout(nudgePlay, 300);
      setTimeout(nudgePlay, 1200);
    }

    /* ====== PERMISSION FLOW ====== */
    async function startExperience() {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch {
        alert("Microfoontoegang geweigerd. Schakel dit in om de tour te gebruiken.");
        return;
      }

      gate.classList.add("hidden");
      bg.style.backgroundImage = `url('${CONVO_BG}')`;
      setTimeout(() => bg.style.backgroundImage = `url('${CONVO_BG}')`, 50);

      setTimeout(() => { nameplate.classList.add("visible"); }, 3000);

      setupAudio();
      startBed();

      injectWidget();
    }

    allowBtn.addEventListener("click", startExperience, { once: true });
    denyBtn.addEventListener("click", () => gate.classList.add("hidden"));
  </script>
</body>
</html>
