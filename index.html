<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Henric Piccardt Tour</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
    }
    .bg {
      position: fixed;
      inset: 0;
      background: url("Background 1.png") center center / cover no-repeat;
      transition: background-image 0.5s ease;
    }
    .gate {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20;
      background: rgba(0,0,0,0.4);
    }
    .card {
      padding: 20px;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 20px rgba(0,0,0,.3);
      text-align: center;
    }
    .btn { padding: 10px 16px; border-radius: 8px; cursor: pointer; }
    .btn-allow { background: #0b6efd; color: #fff; }
    .btn-deny { background: #eee; color: #111; }
    .hidden { display: none; }
    .widget-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 480px;
      z-index: 10;
    }
    .widget-container > elevenlabs-convai {
      width: 100%;
      height: 140px;
    }
  </style>
</head>
<body>
  <div class="bg" id="bg"></div>

  <div class="gate" id="gate">
    <div class="card">
      <h2>Enable voice for your tour?</h2>
      <p>This tour uses the ElevenLabs voice agent and needs access to your microphone.</p>
      <button class="btn btn-deny" id="denyBtn">Not now</button>
      <button class="btn btn-allow" id="allowBtn">Allow</button>
    </div>
  </div>

  <div class="widget-container hidden" id="widgetContainer"></div>

  <audio id="bgMusic" src="Background Music.mp3" loop></audio>

  <script src="https://js.elevenlabs.io/convai-widget/index.js" data-elevenlabs-convai="true"></script>
  <script>
    const AGENT_ID = "agent_4401k3npmamcf5hawj56bagnz96v";
    const bg = document.getElementById("bg");
    const gate = document.getElementById("gate");
    const allowBtn = document.getElementById("allowBtn");
    const denyBtn = document.getElementById("denyBtn");
    const widgetContainer = document.getElementById("widgetContainer");
    const bgMusic = document.getElementById("bgMusic");

    let talkInterval = null;
    let toggle = false;

    function setBackground(image) {
      bg.style.backgroundImage = `url('${image}')`;
    }

    function startTalking() {
      stopTalking();
      toggle = false;
      setBackground("bg_talk_1.png");
      talkInterval = setInterval(() => {
        toggle = !toggle;
        setBackground(toggle ? "bg_talk_2.png" : "bg_talk_1.png");
      }, 3000);
    }

    function stopTalking() {
      if (talkInterval) {
        clearInterval(talkInterval);
        talkInterval = null;
      }
    }

    function injectWidget() {
      widgetContainer.innerHTML =
        `<elevenlabs-convai agent-id="${AGENT_ID}" style="--voice-volume:1;"></elevenlabs-convai>`;
      widgetContainer.classList.remove("hidden");

      const widget = widgetContainer.querySelector("elevenlabs-convai");

      // Hook into session config
      widget.addEventListener("elevenlabs-convai:call", (e) => {
        e.detail.config.onModeChange = ({ mode }) => {
          if (mode === "speaking") {
            startTalking();
          } else if (mode === "listening") {
            stopTalking();
            setBackground("bg_listen_3.png");
          } else {
            stopTalking();
            setBackground("background_convo.png");
          }
        };
      });
    }

    async function startExperience() {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch {
        alert("Microphone permission denied.");
        return;
      }
      setBackground("background_convo.png");
      gate.classList.add("hidden");
      bgMusic.volume = 0.15;
      bgMusic.play().catch(() => {});
      injectWidget();
    }

    allowBtn.addEventListener("click", startExperience);
    denyBtn.addEventListener("click", () => gate.classList.add("hidden"));
  </script>
</body>
</html>
