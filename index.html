<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>Henric Piccardt Tour</title>
  <meta name="theme-color" content="#1d1d1b" />
  <style>
    :root {
      --vh: 1vh;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    html, body {
      height: calc(var(--vh) * 100);
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Background image */
    .bg {
      position: fixed;
      inset: 0;
      background: url("Background 1.png") center center / cover no-repeat;
      transition: background-image .5s ease;
    }
    .bg.conversation {
      background-image: url("background_convo.png");
    }

    /* Permission Gate */
    .gate {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 18%;
      z-index: 20;
      background: rgba(0,0,0,0.12);
    }
    .card {
      width: min(90vw, 420px);
      border-radius: 18px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      padding: 18px;
      text-align: center;
    }
    .card h1 { font-size: 1.1rem; margin: 6px 0 10px; }
    .card p { font-size: .95rem; margin: 0 0 12px; }
    .row { display: flex; gap: 10px; }
    .btn {
      flex: 1 1 auto;
      padding: 12px 14px;
      border-radius: 12px;
      border: 2px solid transparent;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-allow { background: #0b6efd; color: #fff; }
    .btn-deny { background: #eee; color: #111; }

    .hidden { display:none !important; }

    /* Widget container */
    .widget-container {
      position: fixed;
      bottom: calc(var(--safe-bottom) + 10px);
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 480px;
      z-index: 10;
    }
    .widget-container > elevenlabs-convai,
    .widget-container iframe {
      width: 100%;
      height: 140px;
    }
  </style>
</head>
<body>
  <div class="bg" id="bg"></div>

  <!-- Permission Gate -->
  <div class="gate" id="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card">
      <h1 id="gateTitle">Enable voice for your tour?</h1>
      <p>This tour uses the ElevenLabs voice agent and needs access to your microphone.</p>
      <div class="row">
        <button class="btn btn-deny" id="denyBtn">Not now</button>
        <button class="btn btn-allow" id="allowBtn">Allow</button>
      </div>
    </div>
  </div>

  <!-- Where ElevenLabs widget will mount -->
  <div class="widget-container hidden" id="widgetContainer"></div>

  <!-- Background Music -->
  <audio id="bgMusic" src="Background Music.mp3" loop></audio>

  <script>
    const AGENT_ID = "agent_4401k3npmamcf5hawj56bagnz96v";

    const bg   = document.getElementById("bg");
    const gate = document.getElementById("gate");
    const allowBtn = document.getElementById("allowBtn");
    const denyBtn = document.getElementById("denyBtn");
    const widgetContainer = document.getElementById("widgetContainer");
    const bgMusic = document.getElementById("bgMusic");

    let talkInterval = null;
    let talkToggle = false;

    const setBG = (file) => { bg.style.backgroundImage = `url('${file}')`; };
    const startTalkingCycle = () => {
      stopTalkingCycle();
      talkToggle = false;
      setBG("bg_talk_1.png");
      talkInterval = setInterval(() => {
        talkToggle = !talkToggle;
        setBG(talkToggle ? "bg_talk_2.png" : "bg_talk_1.png");
      }, 3000);
    };
    const stopTalkingCycle = () => {
      if (talkInterval) { clearInterval(talkInterval); talkInterval = null; }
    };

    // --- Robust state handling from widget ---
    function handleMode(mode) {
      if (mode === "speaking") {
        startTalkingCycle();
      } else if (mode === "listening") {
        stopTalkingCycle();
        setBG("bg_listen_3.png");
      } else {
        stopTalkingCycle();
        setBG("background_convo.png");
      }
    }

    // Fallback: observe widget text (listening/speaking) if callbacks aren't enabled
    function attachStatusFallback(widgetEl) {
      try {
        // Ensure the widget shows known labels so we can detect them
        widgetEl.setAttribute("listening-text", "Listening...");
        widgetEl.setAttribute("speaking-text", "Assistant speaking");

        const tryWatch = () => {
          const root = widgetEl.shadowRoot;
          if (!root) return; // closed shadow -> fallback won't run

          const observer = new MutationObserver(() => {
            // Search for the status label inside the widget
            const text = root.textContent || "";
            if (text.includes("Assistant speaking")) {
              handleMode("speaking");
            } else if (text.includes("Listening...")) {
              handleMode("listening");
            }
          });
          observer.observe(root, { subtree: true, childList: true, characterData: true });
        };

        // Wait a tick for custom element to upgrade
        setTimeout(tryWatch, 200);
      } catch (_) { /* swallow */ }
    }

    // Load the current official embed (per docs) and mount widget
    function injectWidget() {
      // If the custom element isn't defined, load the official bundle
      const ensureEmbed = (onReady) => {
        if (window.customElements && customElements.get("elevenlabs-convai")) {
          onReady(); return;
        }
        const script = document.createElement("script");
        script.src = "https://unpkg.com/@elevenlabs/convai-widget-embed";
        script.async = true;
        script.type = "text/javascript";
        script.onload = onReady;
        document.body.appendChild(script);
      };

      ensureEmbed(() => {
        widgetContainer.innerHTML = `
          <elevenlabs-convai
            agent-id="${AGENT_ID}"
            style="--voice-volume:1;"
            variant="expanded"
          ></elevenlabs-convai>`;
        widgetContainer.classList.remove("hidden");

        const widget = widgetContainer.querySelector("elevenlabs-convai");

        // 1) Primary: use documented call event to inject callbacks/tools
        widget.addEventListener("elevenlabs-convai:call", (event) => {
          // Hook mode changes reported by the underlying JS SDK
          event.detail.config.onModeChange = ({ mode }) => handleMode(mode);
          // Also reset to convo background when connected/disconnected
          event.detail.config.onConnect = () => setBG("background_convo.png");
          event.detail.config.onDisconnect = () => { stopTalkingCycle(); setBG("background_convo.png"); };
          // (Client tools can still be added here if you use them)
        });

        // 2) Fallback watcher in case onModeChange isn't enabled on the agent
        attachStatusFallback(widget);
      });
    }

    async function startExperience() {
      try {
        // ask for mic permission
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch {
        alert("Microphone permission denied. Please enable it to use the voice tour.");
        return;
      }

      // change background to conversation
      bg.classList.add("conversation");     // keeps your original class-based image
      setBG("background_convo.png");        // and force inline, so swaps can override

      // hide permission box
      gate.classList.add("hidden");

      // play background music at fixed volume
      bgMusic.volume = 0.15;
      bgMusic.play().catch(err => console.log("Autoplay blocked:", err));

      // load & mount ElevenLabs widget
      injectWidget();
    }

    allowBtn.addEventListener("click", startExperience);
    denyBtn.addEventListener("click", () => {
      gate.classList.add("hidden");
    });

    // viewport height fix
    const setVH = () => document.documentElement.style.setProperty("--vh", `${window.innerHeight * 0.01}px`);
    setVH(); window.addEventListener("resize", setVH);
  </script>
</body>
</html>
