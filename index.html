<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>Henric Piccardt Tour</title>
  <meta name="theme-color" content="#1d1d1b" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #000; /* fallback */
    }
    #bg {
      position: fixed;
      inset: 0;
      background: center center / cover no-repeat;
    }
    .gate {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 18%;
      z-index: 20;
      background: rgba(0,0,0,0.12);
    }
    .card {
      width: min(90vw, 420px);
      border-radius: 18px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      padding: 18px;
      text-align: center;
    }
    .card h1 { font-size: 1.1rem; margin: 6px 0 10px; }
    .card p { font-size: .95rem; margin: 0 0 12px; }
    .row { display: flex; gap: 10px; }
    .btn {
      flex: 1 1 auto;
      padding: 12px 14px;
      border-radius: 12px;
      border: 2px solid transparent;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-allow { background: #0b6efd; color: #fff; }
    .btn-deny { background: #eee; color: #111; }
    .hidden { display:none !important; }
    .widget-container {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 480px;
      z-index: 10;
    }
    .widget-container > elevenlabs-convai,
    .widget-container iframe {
      width: 100%;
      height: 140px;
    }
  </style>
</head>
<body>
  <div id="bg" style="background-image:url('Background 1.png')"></div>

  <div class="gate" id="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card">
      <h1 id="gateTitle">Enable voice for your tour?</h1>
      <p>This tour uses the ElevenLabs voice agent and needs access to your microphone.</p>
      <div class="row">
        <button class="btn btn-deny" id="denyBtn">Not now</button>
        <button class="btn btn-allow" id="allowBtn">Allow</button>
      </div>
    </div>
  </div>

  <div class="widget-container hidden" id="widgetContainer"></div>

  <!-- Background music -->
  <audio id="bgMusic" src="Background Music.mp3" loop preload="auto" playsinline webkit-playsinline></audio>

  <script>
    const AGENT_ID = "agent_4401k3npmamcf5hawj56bagnz96v";
    const bg = document.getElementById("bg");
    const gate = document.getElementById("gate");
    const allowBtn = document.getElementById("allowBtn");
    const denyBtn = document.getElementById("denyBtn");
    const widgetContainer = document.getElementById("widgetContainer");
    const bgMusic = document.getElementById("bgMusic");

    let cycleInterval = null;

    const talkImages   = ["bg_talk_1.png","bg_talk_2.png","bg_talk_3.png"];
    const listenImages = ["bg_listen_2.png","bg_listen_3.png","bg_listen_4.png"];
    const allImages    = ["Background 1.png","background_convo.png",...talkImages,...listenImages];

    // preload
    allImages.forEach(src => { const i = new Image(); i.src = src; });

    function setBackground(img) {
      bg.style.backgroundImage = `url('${img}')`;
    }

    function startCycle(images) {
      stopCycle();
      setBackground(images[Math.floor(Math.random() * images.length)]);
      cycleInterval = setInterval(() => {
        setBackground(images[Math.floor(Math.random() * images.length)]);
      }, 2000);
    }
    function stopCycle() {
      if (cycleInterval) {
        clearInterval(cycleInterval);
        cycleInterval = null;
      }
    }

    function attachFallbackWatcher(widgetEl) {
      setTimeout(() => {
        const root = widgetEl.shadowRoot;
        if (!root) return;
        const observer = new MutationObserver(() => {
          const txt = root.textContent.toLowerCase();
          if (txt.includes("listening")) {
            startCycle(listenImages);
          } else if (txt.includes("talk to interrupt")) {
            startCycle(talkImages);
          } else {
            stopCycle();
            setBackground("background_convo.png");
          }
        });
        observer.observe(root, { subtree: true, characterData: true, childList: true });
      }, 300);
    }

    function injectWidget() {
      if (!document.querySelector('script[src*="elevenlabs.io/convai-widget/index.js"]')) {
        const s = document.createElement("script");
        s.src = "https://elevenlabs.io/convai-widget/index.js";
        s.async = true;
        s.setAttribute("data-elevenlabs-convai", "true");
        document.body.appendChild(s);
      }
      widgetContainer.innerHTML = `<elevenlabs-convai agent-id="${AGENT_ID}" style="--voice-volume:1;"></elevenlabs-convai>`;
      widgetContainer.classList.remove("hidden");
      const widget = widgetContainer.querySelector("elevenlabs-convai");
      attachFallbackWatcher(widget);
    }

    // -------- AUDIO MIX FIX (like in the reference) --------
    let audioCtx, bgGainNode;
    function setupAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        bgGainNode = audioCtx.createGain();
        bgGainNode.gain.value = 0.2; // background at 20%

        const src = audioCtx.createMediaElementSource(bgMusic);
        src.connect(bgGainNode).connect(audioCtx.destination);

        window.audioCtx = audioCtx;
        window.bgGainNode = bgGainNode;
      }
      if (audioCtx.state === "suspended") {
        audioCtx.resume().catch(()=>{});
      }
    }

    async function startExperience() {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch {
        alert("Microphone permission denied. Please enable it to use the voice tour.");
        return;
      }

      gate.classList.add("hidden");

      // setup Web Audio graph and play music at fixed soft level
      setupAudio();
      bgMusic.play().catch(err => console.log("Music autoplay blocked:", err));

      // widget voice stays at full (100%)
      injectWidget();
    }

    allowBtn.addEventListener("click", startExperience);
    denyBtn.addEventListener("click", () => gate.classList.add("hidden"));
  </script>
</body>
</html>
