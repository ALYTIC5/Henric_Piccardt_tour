<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>Henric Piccardt Tour</title>
  <meta name="theme-color" content="#1d1d1b" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #000; }
    #bg { position: fixed; inset: 0; background: center center / cover no-repeat; }
    #nameplate { position: fixed; top: 0; left: 50%; transform: translateX(-50%); max-width: 55%; height: auto; z-index: 15; pointer-events: none; opacity: 0; transition: opacity 1.2s ease-in; }
    #nameplate.visible { opacity: 1; }
    .hidden { display: none !important; }

    /* Permission gate */
    .gate { position: fixed; inset: 0; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 18%; z-index: 20; background: rgba(0,0,0,0.05); }
    .card { width: min(90vw, 420px); border-radius: 18px; background: rgba(255,255,255,0.85); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); box-shadow: 0 12px 40px rgba(0,0,0,.25); padding: 18px; text-align: center; }
    .card h1 { font-size: 1.1rem; margin: 6px 0 10px; }
    .card p { font-size: .95rem; margin: 0 10px 12px; }
    .row { display: flex; gap: 10px; }
    .btn { flex: 1 1 auto; padding: 12px 14px; border-radius: 12px; border: 2px solid transparent; font-weight: 600; cursor: pointer; }
    .btn-allow { background: #0b6efd; color: #fff; }
    .btn-deny { background: #eee; color: #111; }

    .small { font-size: 0.86rem; color: #333; margin-top: 8px; }
    .link { color: #0b6efd; text-decoration: underline; cursor: pointer; font-weight: 600; }

    .widget-container { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 480px; z-index: 10; }
    .widget-container > elevenlabs-convai, .widget-container iframe { width: 100%; height: 140px; }

    dialog.privacy { width: min(92vw, 560px); border: none; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.35); padding: 0; max-height: 80vh; }
    dialog::backdrop { background: rgba(0,0,0,0.45); }
    .dialog-body { padding: 18px 18px 6px; }
    .dialog-header { display:flex; align-items:center; justify-content:space-between; padding: 14px 16px; border-bottom: 1px solid #eee; }
    .dialog-title { margin:0; font-size: 1rem; font-weight: 800; }
    .dialog-close { border:none; background:#eee; color:#111; font-weight:700; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .dialog-content { padding: 0 16px 16px; font-size: .95rem; line-height: 1.45; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div id="bg" style="background-image:url('Background 1.png')"></div>
  <img id="nameplate" src="name-removebg.png" alt="Henric Piccardt" />

  <div class="gate" id="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card">
      <h1 id="gateTitle">Microfoon inschakelen?</h1>
      <p>Deze tour gebruikt de ElevenLabs stem-assistent en heeft toegang tot je microfoon nodig.</p>
      <div class="row">
        <button class="btn btn-deny" id="denyBtn">Niet nu</button>
        <button class="btn btn-allow" id="allowBtn">Toestaan</button>
      </div>
      <p class="small">üåê Uitgebreider privacy statement (<span id="openPrivacy" class="link" role="button" tabindex="0" aria-controls="privacyDialog">lees meer</span>)</p>
    </div>
  </div>

  <dialog id="privacyDialog" class="privacy" aria-labelledby="privacyTitle">
    <div class="dialog-header">
      <h2 class="dialog-title" id="privacyTitle">üåê Uitgebreider privacy statement</h2>
      <button class="dialog-close" id="closePrivacy" aria-label="Sluiten">Sluiten</button>
    </div>
    <div class="dialog-body">
      <div class="dialog-content">
Privacyverklaring interactieve audiotour

Deze applicatie wordt aangeboden door Fine Tune Audio. Wanneer u met Henric Piccardt in gesprek gaat, verwerken wij uw ingevoerde tekst of gesproken woorden om direct een antwoord te genereren. Hiervoor maken wij gebruik van:

OpenAI (taalverwerking)

ElevenLabs (tekst-naar-spraak)

Uw gegevens worden uitsluitend gebruikt om de gesprekken in realtime mogelijk te maken. Ze worden niet opgeslagen door Fine Tune Audio, OpenAI of ElevenLabs.

Rechtsgrond: dit gebeurt op basis van uw toestemming.
Uw rechten: u kunt uw toestemming altijd intrekken en vragen stellen over de verwerking.
Contact: support@finetune.audio
      </div>
    </div>
  </dialog>

  <div class="widget-container hidden" id="widgetContainer"></div>
  <!-- Important for iOS: preload and keep inline -->
  <audio id="bgMusic" src="BG_Whisper.mp3" loop preload="auto" playsinline webkit-playsinline></audio>

  <script>
    /* ====== CONFIG ====== */
    const AGENT_ID = "agent_4401k3npmamcf5hawj56bagnz96v";

    /* ====== DOM ====== */
    const bg = document.getElementById("bg");
    const gate = document.getElementById("gate");
    const allowBtn = document.getElementById("allowBtn");
    const denyBtn = document.getElementById("denyBtn");
    const widgetContainer = document.getElementById("widgetContainer");
    const bgMusic = document.getElementById("bgMusic");
    const nameplate = document.getElementById("nameplate");

    // Privacy dialog
    const privacyDialog = document.getElementById("privacyDialog");
    document.getElementById("openPrivacy").addEventListener("click", () => privacyDialog.showModal());
    document.getElementById("closePrivacy").addEventListener("click", () => privacyDialog.close());

    /* ====== Helpers ====== */
    function setBackground(img) { bg.style.backgroundImage = `url('${img}')`; }

    function injectWidget() {
      if (!document.querySelector('script[src*="elevenlabs.io/convai-widget/index.js"]')) {
        const s = document.createElement("script");
        s.src = "https://elevenlabs.io/convai-widget/index.js";
        s.async = true;
        s.setAttribute("data-elevenlabs-convai", "true");
        document.body.appendChild(s);
      }
      widgetContainer.innerHTML = `<elevenlabs-convai agent-id="${AGENT_ID}" style="--voice-volume:1;"></elevenlabs-convai>`;
      widgetContainer.classList.remove("hidden");
      setTimeout(() => setBackground("background_convo.png"), 200);
      setTimeout(() => setBackground("background_convo.png"), 1000);
    }

    // ====== Audio ======
    let audioCtx, bgGainNode, mediaElSource, primed = false;

    function createOrResumeCtx() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') {
        return audioCtx.resume().catch(() => {});
      }
      return Promise.resolve();
    }

    function wireGraphOnce() {
      if (!bgGainNode) {
        bgGainNode = audioCtx.createGain();
        bgGainNode.gain.value = 0.2; // 20%
      }
      // createMediaElementSource can only be created ONCE per element
      if (!mediaElSource) {
        try {
          mediaElSource = audioCtx.createMediaElementSource(bgMusic);
          mediaElSource.connect(bgGainNode).connect(audioCtx.destination);
        } catch (e) {
          // If it already exists (Safari quirk), ignore
        }
      }
    }

    // Prime audio on the very first user gesture (most reliable across iOS/Android/Chrome)
    async function primeAudio() {
      if (primed) return;
      primed = true;
      try {
        await createOrResumeCtx();
        wireGraphOnce();
        // Start muted within the gesture, then unmute later ‚Äî maximizes autoplay success
        bgMusic.muted = true;
        // Ensure a load attempt
        try { bgMusic.load(); } catch {}
        await bgMusic.play();
      } catch (err) {
        console.debug('Prime audio failed:', err);
        primed = false; // let us retry on next gesture
      }
    }

    function unmuteAndPlay() {
      // Unmute and ensure playback keeps going
      bgMusic.muted = false;
      const kick = () => bgMusic.play().catch(() => {});
      kick();
      [150, 600, 1200, 2500].forEach(t => setTimeout(kick, t));
    }

    // Extra resilience: if audio context ever gets suspended (tab backgrounded), resume + play
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        createOrResumeCtx().then(() => unmuteAndPlay());
      }
    });

    // ====== Flow ======
    async function startExperience() {
      try {
        // Ask mic (required by your app) AFTER we've primed audio in the same gesture
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch {
        alert("Microfoontoegang geweigerd. Schakel dit in om de tour te gebruiken.");
        return;
      }

      gate.classList.add("hidden");
      setBackground("background_convo.png");
      setTimeout(() => setBackground("background_convo.png"), 50);
      setTimeout(() => { nameplate.classList.add("visible"); }, 3000);

      // Unmute + keep it alive now that we're past permissions
      unmuteAndPlay();

      // Inject the assistant widget
      injectWidget();
    }

    // ====== Event wiring ======
    // 1) Prime on the earliest possible gesture for best autoplay reliability
    const GESTURE_EVENTS = ['pointerdown','touchstart','mousedown','keydown'];
    GESTURE_EVENTS.forEach(ev => allowBtn.addEventListener(ev, primeAudio, { once: false }));

    // 2) Start the experience on click (after prime)
    allowBtn.addEventListener("click", startExperience);

    // 3) Deny just hides the gate
    denyBtn.addEventListener("click", () => gate.classList.add("hidden"));

    // 4) Fallback: if a user taps anywhere on the page before pressing Allow, also prime
    GESTURE_EVENTS.forEach(ev => document.addEventListener(ev, primeAudio, { once: true, capture: true }));

    // 5) Preload background for snappy switch
    (new Image()).src = "background_convo.png";
  </script>
</body>
</html>
