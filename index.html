<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>Henric Piccardt Tour</title>
  <meta name="theme-color" content="#1d1d1b" />
  <style>
    :root {
      --vh: 1vh;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    html, body {
      height: calc(var(--vh) * 100);
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Background image */
    .bg {
      position: fixed;
      inset: 0;
      background: url("Background 1.png") center center / cover no-repeat;
      transition: background-image .5s ease;
    }
    .bg.conversation {
      background-image: url("background_convo.png");
    }

    /* TALKING STATE EFFECTS */
    .bg.conversation.talking {
      animation: headBob 1.1s ease-in-out infinite;
    }
    @keyframes headBob {
      0%,100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-0.6%) scale(1.003); }
    }

    /* Mouth overlay: tweak the variables below to fit the portrait */
    #henricMouth {
      --mouth-x: 52.8vw;   /* horizontal center position */
      --mouth-y: 58.2vh;   /* vertical position */
      --mouth-w: 9vw;      /* width */
      --mouth-h: 2.2vh;    /* height */

      position: fixed;
      left: calc(var(--mouth-x) - var(--mouth-w)/2);
      top: calc(var(--mouth-y) - var(--mouth-h)/2);
      width: var(--mouth-w);
      height: var(--mouth-h);
      border-radius: 50% / 60%;
      background: radial-gradient(ellipse at center, rgba(60,20,10,0.9) 0%, rgba(35,10,5,0.95) 55%, rgba(0,0,0,0.95) 80%);
      box-shadow: 0 2px 0 rgba(255,196,160,0.35) inset; /* subtle lip highlight */
      opacity: 0; /* hidden by default */
      transform-origin: center top;
      z-index: 9; /* sits above background, below widget */
      pointer-events: none;
    }
    .talking + #henricMouth,
    .bg.talking ~ #henricMouth { /* show when background has .talking */
      opacity: 1;
      animation: mouthTalk 240ms steps(2) infinite;
    }
    @keyframes mouthTalk {
      0%   { transform: scaleY(0.2); filter: blur(0.3px); }
      50%  { transform: scaleY(1);   filter: blur(0); }
      100% { transform: scaleY(0.35); filter: blur(0.2px); }
    }

    /* Permission Gate */
    .gate {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 18%;
      z-index: 20;
      background: rgba(0,0,0,0.12);
    }
    .card {
      width: min(90vw, 420px);
      border-radius: 18px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      padding: 18px;
      text-align: center;
    }
    .card h1 { font-size: 1.1rem; margin: 6px 0 10px; }
    .card p { font-size: .95rem; margin: 0 0 12px; }
    .row { display: flex; gap: 10px; }
    .btn {
      flex: 1 1 auto;
      padding: 12px 14px;
      border-radius: 12px;
      border: 2px solid transparent;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-allow { background: #0b6efd; color: #fff; }
    .btn-deny { background: #eee; color: #111; }

    .hidden { display:none !important; }

    /* Widget container */
    .widget-container {
      position: fixed;
      bottom: calc(var(--safe-bottom) + 10px);
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 480px;
      z-index: 10;
    }
    .widget-container > elevenlabs-convai,
    .widget-container iframe {
      width: 100%;
      height: 140px;
    }

    /* Volume control */
    .volume-control {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 30;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      padding: 6px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="bg" id="bg"></div>
  <!-- Simple mouth overlay that toggles when agent speaks -->
  <div id="henricMouth" aria-hidden="true"></div>

  <!-- Permission Gate -->
  <div class="gate" id="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card">
      <h1 id="gateTitle">Enable voice for your tour?</h1>
      <p>This tour uses the ElevenLabs voice agent and needs access to your microphone.</p>
      <div class="row">
        <button class="btn btn-deny" id="denyBtn">Not now</button>
        <button class="btn btn-allow" id="allowBtn">Allow</button>
      </div>
    </div>
  </div>

  <!-- Where ElevenLabs widget will mount -->
  <div class="widget-container hidden" id="widgetContainer"></div>

  <!-- Background Music -->
  <audio id="bgMusic" src="Background Music.mp3" loop></audio>

  <!-- Volume Control -->
  <div class="volume-control hidden" id="volumeControl">
    <label for="volumeRange">Volume:</label>
    <input type="range" id="volumeRange" min="0" max="1" step="0.01" value="1">
  </div>

  <script>
    const AGENT_ID = "agent_4401k3npmamcf5hawj56bagnz96v";

    const bg   = document.getElementById("bg");
    const gate = document.getElementById("gate");
    const allowBtn = document.getElementById("allowBtn");
    const denyBtn = document.getElementById("denyBtn");
    const widgetContainer = document.getElementById("widgetContainer");
    const bgMusic = document.getElementById("bgMusic");
    const mouth = document.getElementById("henricMouth");
    const volumeControl = document.getElementById("volumeControl");
    const volumeRange = document.getElementById("volumeRange");

    function injectWidget() {
      if (!document.querySelector('script[src*="elevenlabs.io/convai-widget/index.js"]')) {
        const script = document.createElement("script");
        script.src = "https://elevenlabs.io/convai-widget/index.js";
        script.async = true;
        script.setAttribute("data-elevenlabs-convai", "true");
        document.body.appendChild(script);
      }
      widgetContainer.innerHTML = `<elevenlabs-convai agent-id="${AGENT_ID}"></elevenlabs-convai>`;
      widgetContainer.classList.remove("hidden");

      // Hook up speaking/listening events from the ElevenLabs widget
      wireConvaiSpeakingEvents();
    }

    async function startExperience() {
      try {
        // ask for mic permission
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch {
        alert("Microphone permission denied. Please enable it to use the voice tour.");
        return;
      }

      // change background to portrait
      bg.classList.add("conversation");

      // hide permission box
      gate.classList.add("hidden");

      // play background music
      bgMusic.volume = parseFloat(volumeRange.value);
      bgMusic.play().catch(err => console.log("Autoplay blocked:", err));

      // show volume control
      volumeControl.classList.remove("hidden");

      // load & mount ElevenLabs widget
      injectWidget();
    }

    allowBtn.addEventListener("click", startExperience);
    denyBtn.addEventListener("click", () => {
      gate.classList.add("hidden");
    });

    // volume adjustment
    volumeRange.addEventListener("input", (e) => {
      bgMusic.volume = parseFloat(e.target.value);
    });

    // viewport height fix
    const setVH = () => document.documentElement.style.setProperty("--vh", `${window.innerHeight * 0.01}px`);
    setVH(); window.addEventListener("resize", setVH);
  
    /**
     * Toggle portrait talking state
     */
    function setTalking(isTalking){
      bg.classList.toggle('talking', !!isTalking);
    }

    /**
     * Wire ElevenLabs Convai events -> setTalking(true/false)
     * Tries multiple strategies to remain robust against widget updates.
     */
    function wireConvaiSpeakingEvents(){
      // 1) Custom DOM events (preferred)
      const evtNames = [
        'elevenlabs:agent-started-speaking',
        'elevenlabs:agent-stopped-speaking',
        'elevenlabs:assistant-started-speaking',
        'elevenlabs:assistant-stopped-speaking'
      ];
      evtNames.forEach(n => window.addEventListener(n, (e)=>{
        const on = /started/.test(n);
        setTalking(on);
        console.debug('[convai]', n, e.detail||'');
      }));

      // 2) postMessage from iframe (fallback)
      window.addEventListener('message', (event) => {
        if (!event.origin || !/elevenlabs\.io$/.test(new URL(event.origin).host)) return;
        const data = event.data || {};
        const type = (data.type||data.event||'').toString();
        if (/agent-started-speaking|assistant-started-speaking/.test(type)) setTalking(true);
        if (/agent-stopped-speaking|assistant-stopped-speaking/.test(type)) setTalking(false);
        if (/listening-started/.test(type)) setTalking(false);
        if (/listening-stopped/.test(type)) setTalking(false);
        console.debug('[convai:message]', type, data);
      });

      // 3) MutationObserver on the web component (bestâ€‘effort)
      const el = document.querySelector('elevenlabs-convai');
      if (el) {
        const mo = new MutationObserver(()=>{
          const state = el.getAttribute('data-state')||'';
          if (/speaking/i.test(state)) setTalking(true);
          if (/listening|idle/i.test(state)) setTalking(false);
        });
        mo.observe(el, { attributes:true, attributeFilter:['data-state','class'] });
      }
    }
  </script>
</body>
</html>
