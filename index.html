<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Henric Piccardt Tour</title>
  <meta name="theme-color" content="#1d1d1b" />
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0; overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #000;
    }
    #bg { position: fixed; inset: 0; background: center center / cover no-repeat; }
    .hidden { display: none !important; }

    /* Permission gate */
    .gate { position: fixed; inset: 0; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 18%; z-index: 20; background: rgba(0,0,0,0.05); }
    .card { width: min(90vw, 420px); border-radius: 18px; background: rgba(255,255,255,0.85); backdrop-filter: blur(4px); box-shadow: 0 12px 40px rgba(0,0,0,.25); padding: 18px; text-align: center; }
    .card h1 { font-size: 1.1rem; margin: 6px 0 10px; }
    .card p { font-size: .95rem; margin: 0 10px 12px; }
    .row { display: flex; gap: 10px; }
    .btn { flex: 1 1 auto; padding: 12px 14px; border-radius: 12px; border: 2px solid transparent; font-weight: 600; cursor: pointer; }
    .btn-allow { background: #0b6efd; color: #fff; }
    .btn-deny { background: #eee; color: #111; }

    .widget-container { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 480px; z-index: 10; }
    .widget-container > elevenlabs-convai, .widget-container iframe { width: 100%; height: 140px; }
  </style>
</head>
<body>
  <div id="bg" style="background-image:url('Background 1.png')"></div>

  <!-- Permission Gate -->
  <div class="gate" id="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card">
      <h1 id="gateTitle">Microfoon inschakelen?</h1>
      <p>Deze tour gebruikt de ElevenLabs stem-assistent en heeft toegang tot je microfoon nodig.</p>
      <div class="row">
        <button class="btn btn-deny" id="denyBtn">Niet nu</button>
        <button class="btn btn-allow" id="allowBtn">Toestaan</button>
      </div>
    </div>
  </div>

  <!-- ElevenLabs widget -->
  <div class="widget-container hidden" id="widgetContainer"></div>

  <!-- Background Music (permanently Whisper) -->
  <audio id="bgMusic" src="BG_Whisper.mp3" loop preload="auto" playsinline webkit-playsinline></audio>

  <script>
    const AGENT_ID = "agent_4401k3npmamcf5hawj56bagnz96v";

    const bg = document.getElementById("bg");
    const gate = document.getElementById("gate");
    const allowBtn = document.getElementById("allowBtn");
    const denyBtn = document.getElementById("denyBtn");
    const widgetContainer = document.getElementById("widgetContainer");
    const bgMusic = document.getElementById("bgMusic");

    // Mute the element's own output; all sound goes through Web Audio @ 0.2
    bgMusic.volume = 0;

    let audioCtx, bgGainNode, mediaElSource, primed = false;

    function createOrResumeCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') return audioCtx.resume().catch(() => {});
      return Promise.resolve();
    }

    function wireGraphOnce() {
      if (!bgGainNode) {
        bgGainNode = audioCtx.createGain();
        bgGainNode.gain.value = 0.2; // fixed 20%
      }
      if (!mediaElSource) {
        try {
          mediaElSource = audioCtx.createMediaElementSource(bgMusic);
          mediaElSource.connect(bgGainNode).connect(audioCtx.destination);
        } catch {}
      }
    }

    async function primeAudio() {
      // Play muted during a gesture to satisfy autoplay policies
      try {
        await createOrResumeCtx();
        wireGraphOnce();
        bgMusic.muted = true;
        bgMusic.load();
        await bgMusic.play();
        primed = true;
      } catch (err) {
        primed = false; // we'll try again on click
      }
    }

    function robustPlayUnmuted() {
      // Unmute and aggressively ensure playback continues
      bgMusic.muted = false;
      const tryPlay = () => bgMusic.play().catch(() => {});
      tryPlay();
      [100, 300, 800, 1500, 3000].forEach(t => setTimeout(tryPlay, t));
    }

    function injectWidget() {
      // Primary + fallback loader
      function loadScript(src, cb) {
        const s = document.createElement("script");
        s.src = src; s.async = true;
        s.onload = cb;
        s.onerror = () => console.warn("Failed loading", src);
        document.body.appendChild(s);
      }
      if (!customElements.get("elevenlabs-convai")) {
        loadScript("https://elevenlabs.io/convai-widget/index.js", () => {
          if (!customElements.get("elevenlabs-convai")) {
            loadScript("https://unpkg.com/@elevenlabs/convai-widget-embed", () => {});
          }
        });
      }
      widgetContainer.innerHTML = `<elevenlabs-convai agent-id="${AGENT_ID}" style="--voice-volume:1;"></elevenlabs-convai>`;
      widgetContainer.classList.remove("hidden");
    }

    async function startExperience() {
      // Ask mic inside the same gesture
      try { await navigator.mediaDevices.getUserMedia({ audio: true }); }
      catch { alert("Microfoontoegang geweigerd."); return; }

      // Make absolutely sure the audio graph exists before playing
      await createOrResumeCtx();
      wireGraphOnce();

      // If we didn't manage to prime earlier, do it now (still inside click)
      if (!primed) {
        try {
          bgMusic.muted = true;
          bgMusic.load();
          await bgMusic.play();
          primed = true;
        } catch {}
      }

      // Switch background and start music (unmuted) with retries
      gate.classList.add("hidden");
      bg.style.backgroundImage = "url('background_convo.png')";
      robustPlayUnmuted();

      // Widget
      injectWidget();
    }

    // Event wiring
    // Pre-prime on any early gesture for better iOS reliability
    ["pointerdown","touchstart","mousedown","keydown"].forEach(ev => {
      allowBtn.addEventListener(ev, primeAudio, { once: false });
    });
    // Start on click
    allowBtn.addEventListener("click", startExperience);
    denyBtn.addEventListener("click", () => gate.classList.add("hidden"));
    // One-time page-level prime (in case user taps elsewhere first)
    ["pointerdown","touchstart","mousedown","keydown"].forEach(ev => {
      document.addEventListener(ev, primeAudio, { once: true, capture: true });
    });

    // If the tab regains focus or the context suspends, resume + ensure playback
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        createOrResumeCtx().then(() => robustPlayUnmuted());
      }
    });
  </script>
</body>
</html>
