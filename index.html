<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>Fraeylemaborg â€“ Audio Tour</title>
  <meta name="theme-color" content="#1d1d1b" />
  <style>
    :root {
      --vh: 1vh;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }
    html, body {
      height: calc(var(--vh) * 100);
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #433;
    }

    /* Background */
    .bg {
      position: fixed;
      inset: 0;
      background: url("Background 1.png") center center / cover no-repeat fixed;
      transition: opacity .45s ease, filter .45s ease, background-image .2s linear;
      will-change: opacity, filter;
    }
    .bg.conversation { background-image: url("Background Conversation.png"); }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      /* lighter & no blur so the background is clearly visible under the prompt */
      background: radial-gradient(ellipse at center, rgba(0,0,0,.03), rgba(0,0,0,.18));
      pointer-events:none;
    }

    /* Permission Gate (translucent so background is visible) */
    .gate {
      position: fixed; inset: 0;
      display: grid; place-items: center;
      padding: 20px; z-index: 20;
      background: rgba(0,0,0,.12); /* lighter overlay */
    }
    .card {
      width: min(92vw, 520px);
      border-radius: 18px;
      background: rgba(255,255,255,.96);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      padding: 20px 18px; text-align: center;
    }
    .card h1 { font-size: 1.15rem; margin: 4px 0 8px; line-height: 1.2; }
    .card p { font-size: .95rem; color: #333; opacity: .9; line-height: 1.35; margin: 0 0 14px; }
    .row { display: flex; gap: 10px; margin-top: 6px; }
    .btn { flex: 1 1 auto; padding: 14px 16px; border-radius: 14px; border: 2px solid transparent; font-weight: 700; letter-spacing: .2px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; cursor: pointer; }
    .btn-allow { background: #0b6efd; color: #fff; }
    .btn-allow:active { filter: brightness(.95); }
    .btn-deny { background: #f1f1f1; color: #111; border-color: #e6e6e6; }
    .btn-deny:active { background: #e9e9e9; }

    .hidden { display:none !important; }
    .fade-out { opacity:0; transition: opacity .35s ease; }

    /* Bottom dock for the widget */
    .dock {
      position: fixed;
      left: max(12px, var(--safe-left));
      right: max(12px, var(--safe-right));
      bottom: calc(max(12px, var(--safe-bottom)) + 0px);
      z-index: 10;
      padding: 8px 10px;
      border-radius: 18px;
      background: rgba(255,255,255,.90);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      transform: translateY(20px);
      opacity: 0;
      transition: transform .4s ease, opacity .4s ease;
    }
    .dock.visible { transform: translateY(0); opacity: 1; }
    .dock > elevenlabs-convai, .dock iframe { width: 100%; height: 78px; display: block; }

    .toast {
      position: fixed; left: 50%;
      bottom: calc(var(--safe-bottom) + 90px);
      transform: translateX(-50%);
      padding: 10px 14px; border-radius: 12px;
      background: rgba(0,0,0,.78); color: #fff;
      font-size: 12px; z-index: 30; opacity: 0; pointer-events: none; transition: opacity .3s;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="bg" id="bg"></div>

  <!-- Background music -->
  <audio id="bgm" src="Background Music.mp3" preload="auto" loop playsinline></audio>

  <!-- Permission Gate -->
  <div class="gate" id="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card">
      <h1 id="gateTitle">Enable voice for your tour?</h1>
      <p>
        This tour uses the ElevenLabs voice agent and needs access to your microphone.
        Tap <strong>Allow</strong> to continue.
      </p>
      <div class="row">
        <button class="btn btn-deny" id="denyBtn">Not now</button>
        <button class="btn btn-allow" id="allowBtn">Allow</button>
      </div>
    </div>
  </div>

  <!-- Bottom dock for the widget -->
  <div class="dock" id="dock" aria-live="polite"></div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // dynamic 100vh fix
    const setVH = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    setVH(); window.addEventListener('resize', setVH);

    // --- CONFIG ---
    const AGENT_ID = 'agent_4401k3npmamcf5hawj56bagnz96v';
    const ELEVEN_SCRIPT_URL = 'https://unpkg.com/@elevenlabs/convai-widget-embed';

    const bg   = document.getElementById('bg');
    const gate = document.getElementById('gate');
    const dock = document.getElementById('dock');
    const toast= document.getElementById('toast');
    const allowBtn = document.getElementById('allowBtn');
    const denyBtn  = document.getElementById('denyBtn');
    const bgm = document.getElementById('bgm');

    function showToast(msg, ms = 2200) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), ms);
    }

    // Try to autoplay background music ASAP; if blocked, start on first interaction
    let bgmWanted = true;
    let bgmStarted = false;

    function fadeInAudio(target = 0.35, step = 0.02, every = 80) {
      bgm.volume = 0.0;
      const id = setInterval(() => {
        bgm.volume = Math.min(target, bgm.volume + step);
        if (bgm.volume >= target) clearInterval(id);
      }, every);
    }

    async function startBgmIfNeeded() {
      if (!bgmWanted || bgmStarted) return;
      try {
        await bgm.play();
        bgmStarted = true;
        fadeInAudio();
      } catch (e) {
        // Autoplay blocked; we'll retry on first user gesture.
      }
    }

    // Attempt on load/visibility
    document.addEventListener('DOMContentLoaded', startBgmIfNeeded);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') startBgmIfNeeded();
    });

    // Start on first user gesture if blocked
    const kickstart = () => { startBgmIfNeeded(); window.removeEventListener('click', kickstart); window.removeEventListener('touchstart', kickstart); };
    window.addEventListener('click', kickstart, { once: true });
    window.addEventListener('touchstart', kickstart, { once: true });

    function loadElevenLabs() {
      return new Promise((resolve, reject) => {
        if (customElements.get('elevenlabs-convai')) return resolve();
        const s = document.createElement('script');
        s.src = ELEVEN_SCRIPT_URL;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error('Failed to load ElevenLabs widget.'));
        document.head.appendChild(s);
      });
    }

    async function startExperience() {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (err) {
        showToast('Microphone permission denied. You can enable it and try again.');
        return;
      }

      // swap background
      bg.classList.add('conversation');

      // hide gate
      gate.classList.add('fade-out');
      setTimeout(() => gate.classList.add('hidden'), 360);

      // ensure bgm is playing (if it was blocked before)
      startBgmIfNeeded();

      // load & mount widget
      try {
        await loadElevenLabs();
        dock.innerHTML = `<elevenlabs-convai agent-id="${AGENT_ID}"></elevenlabs-convai>`;
        requestAnimationFrame(() => dock.classList.add('visible'));
      } catch (e) {
        console.error(e);
        showToast('Could not initialize the voice agent.');
      }
    }

    allowBtn.addEventListener('click', startExperience);

    denyBtn.addEventListener('click', () => {
      gate.classList.add('fade-out');
      setTimeout(() => gate.classList.add('hidden'), 360);
      showToast('Voice disabled. Tap the top area to enable later.');
    });

    // Re-open gate if user denied and taps near top
    document.addEventListener('click', (e) => {
      if (!gate.classList.contains('hidden')) return;
      if (!dock.children.length && e.clientY < 100) {
        gate.classList.remove('hidden', 'fade-out');
      }
    });
  </script>
</body>
</html>
